version: "3.9"

services:
  # ============================================================
  # Zookeeper (for Kafka)
  # ============================================================
  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: zookeeper
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"
    networks:
      - fraud-network

  # ============================================================
  # Kafka Broker
  # ============================================================
  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - ALLOW_PLAINTEXT_LISTENER=yes
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 5

  # ============================================================
  # Kafka Topics Initialization
  # ============================================================
  kafka-init:
    image: bitnami/kafka:3.7
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - fraud-network
    entrypoint: /bin/bash
    command: |
      -c "
      echo 'Creating Kafka topics...'
      kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic raw-transactions
      kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic fraud-alerts
      echo 'Topics created:'
      kafka-topics.sh --list --bootstrap-server kafka:9092
      "

  # ============================================================
  # Hadoop NameNode
  # ============================================================
  namenode:
    image: apache/hadoop:3.3.6
    container_name: namenode
    hostname: namenode
    ports:
      - "9870:9870"
      - "9000:9000"
    environment:
      - HADOOP_HOME=/opt/hadoop
      - ENSURE_NAMENODE_DIR=/tmp/hadoop-root/dfs/name
    command: bash -c "hdfs namenode -format -force && hdfs namenode"
    env_file:
      - ./hadoop.env
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9870/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ============================================================
  # Hadoop DataNode
  # ============================================================
  datanode:
    image: apache/hadoop:3.3.6
    container_name: datanode
    hostname: datanode
    depends_on:
      namenode:
        condition: service_healthy
    ports:
      - "9864:9864"
    environment:
      - HADOOP_HOME=/opt/hadoop
    command: hdfs datanode
    env_file:
      - ./hadoop.env
    networks:
      - fraud-network

  # ============================================================
  # Flink Job Manager
  # ============================================================
  flink-jobmanager:
    image: flink:1.19-java17
    container_name: flink-jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        state.backend: hashmap
        state.checkpoints.dir: file:///tmp/flink-checkpoints
    networks:
      - fraud-network

  # ============================================================
  # Flink Task Manager
  # ============================================================
  flink-taskmanager:
    image: flink:1.19-java17
    container_name: flink-taskmanager
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        state.backend: hashmap
        state.checkpoints.dir: file:///tmp/flink-checkpoints
    networks:
      - fraud-network

  # ============================================================
  # Spark Master
  # ============================================================
  spark-master:
    image: bitnami/spark:3.5
    container_name: spark-master
    ports:
      - "8083:8080"
      - "7077:7077"
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master
    networks:
      - fraud-network

  # ============================================================
  # Spark Worker
  # ============================================================
  spark-worker:
    image: bitnami/spark:3.5
    container_name: spark-worker
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
    networks:
      - fraud-network

  # ============================================================
  # Transaction API (Spring Boot)
  # ============================================================
  transaction-api:
    build:
      context: ./transaction-api
      dockerfile: Dockerfile
    container_name: transaction-api
    ports:
      - "8080:8080"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - fraud-network
    restart: on-failure

  # ============================================================
  # Fraud Alert Service (Spring Boot)
  # ============================================================
  fraud-alert-service:
    build:
      context: ./fraud-alert-service
      dockerfile: Dockerfile
    container_name: fraud-alert-service
    ports:
      - "8082:8082"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - fraud-network
    restart: on-failure

networks:
  fraud-network:
    driver: bridge
